@model Music.ViewModels.Album.AlbumCreateViewModel

@{
    ViewData["Title"] = "Добавление альбома";
}

<div class="container mt-5">
    <h2 class="mb-4">Добавить альбом для @Model.Artist.Name </h2>

    <form asp-controller="Album" asp-action="Create" method="post">

        <div class="mb-3">
            <label asp-for="@Model.Album.Name" class="form-label">Навзвание альбома</label>
            <input asp-for="@Model.Album.Name" class="form-control" placeholder="Введите название"/>
        </div>

        <div class="mb-3">
            <label asp-for="@Model.Album.UrlImg" class="form-label">URL карточки альбома</label>
            <input asp-for="@Model.Album.UrlImg" class="form-control" placeholder="https://example.com/image.jpg"/>
        </div>

        <div class="mb-3">
            <label asp-for="@Model.Album.YearOfIssue" class="form-label">Дата релиза</label>
            <input asp-for="@Model.Album.YearOfIssue" class="form-control" placeholder="Введите дату"/>
        </div>

        <h3 class="mt-4">Треки</h3>
        <!-- скрываемые поля для треков, которые будут динамически добавляться -->
        <div id="hiddenSongsInputs"></div>

        <!-- Контейнер для динамически добавляемых треков -->
        <div id="songsContainer"></div>

        <!--Поле для добавления треков-->
        <div id="inputAddSongs"></div>

        <button id="addSongButton" class="btn btn-success mb-3">Добавить трек</button>

        <button type="submit" class="btn btn-primary mb-3">Добавить альбом</button>
    </form>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger mt-3">
            @TempData["ErrorMessage"]
        </div>
        //TODO Настроить возможность добавления трека уже в бд
        //TODO Добавить возможность добавления картинки. 
    }
</div>


        
@section Scripts
{
    <script>
        $(document).ready(function() {
            let songIndex = 0;
            const songs = [];

            function addSongField() {
                const songField = `
                    <div class="song-input mb-3">
                        <input type="file" name="audioFiles" id="inputFile" multiple />
                        <button type="button" class="btn btn-success mt-2 saveSong">Сохранить</button>
                    </div>  
                `;
                $('#inputAddSongs').append(songField);
            }


            // При клике на "Добавить трек"
            $('#addSongButton').on('click',
                function(e) {
                    e.preventDefault();
                    addSongField();
                });

            // При клике на "Сохранить"
            $('#inputAddSongs').on('click', '.saveSong', async function () {
                const input = document.getElementById('inputFile');
                const files = input.files;

                if (!files.length) {
                    alert('Выберите хотя бы один файл');
                    return;
                }

                const formData = new FormData();
                for (const file of files) {
                    formData.append('audioFiles', file); // Обрати внимание на 'audioFiles'
                }

                const response = await fetch('/Cloudinary/Audio', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const songs = await response.json();

                    for (const song of songs) {
                        const trackHtml = `
                            <div class="track-item">
                              <div class="track-number">${songIndex + 1}</div>
                              <div class="track-info">
                                  <h6 class="mb-0">${song.fileName}</h6>
                              </div>
                              <audio controls class="audio-player">
                                  <source src="${song.url}" type="audio/mpeg">
                                  Ваш браузер не поддерживает аудио элемент.
                              </audio>
                          </div>
                        `;
                        $('#songsContainer').append(trackHtml);
                        songIndex++;
                    }

                    $(this).closest('.song-input').remove();
                } else {
                    alert('Ошибка при загрузке файлов');
                }
            });


            // Обновляем hidden inputs для отправки на сервер
            function renderHiddenInputs() {
                $('#hiddenSongsInputs').empty();
                songs.forEach((song, index) => {
                    $('#hiddenSongsInputs').append(`
                        <input type="hidden" name="Album.Songs[${index}].Name" value="${song.name}" />
                        <input type="hidden" name="Album.Songs[${index}].UrlSong" value="${song.url}" />
                    `);
                });
            }

            // Инициализация
            addSongField();
        });
    </script>
}